<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>历史结果</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="./static/vue.js"></script>
    <script src="./static/dist/xlsx.core.min.js"></script>
    <link rel="stylesheet" href="static/style_result.css">
  </head>
  <body>
      <div>
          <div id='buttons'>
              <button>删除选中</button>
              <button>图表分析</button>
          </div>
        <div id='left_check'>
            <table id='check' class='result_sheets'>
                <tr><th>全选<input type="checkbox" name="name1"/></th></tr>
            </table>
        </div>
        <div id='right_result'>
            <table id='result_sheet' class='result_sheets'>
                <thead>
                    <tr><th>序号</th><th>时间</th><th>总分</th><th>灰平衡彩度差</th><th>青网扩</th><th>青密度</th><th>青色色差</th><th>品网扩</th><th>品密度</th><th>品色色差</th><th>黄网扩</th><th>黄密度</th><th>黄色色差</th><th>黑网扩</th><th>黑密度</th><th>黑色色差</th><th>报头M密度</th><th>报头Y密度</th><th>报头色差</th><th>中间调扩展值</th></tr>
                </thead>
                <tbody id='result_sheet_body'>
                </tbody>
            </table>
        </div>
      </div>
    <script>
        var xmlhttp;
        //var results;
        if (window.XMLHttpRequest)
        {
            //  IE7+, Firefox, Chrome, Opera, Safari 浏览器执行代码
            xmlhttp=new XMLHttpRequest();
        }
        else
        {
            // IE6, IE5 浏览器执行代码
            xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
        }
        xmlhttp.responseType='json';
        xmlhttp.open('POST','/result');
        var data={
            type:'init'
        }
        xmlhttp.send(JSON.stringify(data));
        xmlhttp.onreadystatechange = function(){
            if(xmlhttp.readyState === 4){
                if(xmlhttp.status>=200&&xmlhttp.status<300){
                    //console.log(xmlhttp.response); 
                    var results=xmlhttp.response;
                    //console.log(typeof results);
                    tab=document.getElementById('result_sheet_body');
                    /*for(let i=0;i<results.length;++i){
                        var td = document.createElement("td");
                        td.innerHTML='test';
                        var tr = document.createElement("tr");
                        tr.appendChild(td);
                        tab.appendChild(tr);
                    }*/
                    const sheet2JSONOpts = {
                        /** Default value for null/undefined values */
                        defval: 'null',//Assign empty string to defval
                    };
                    for(let i=0;i<results.length;++i){
                        results[i][0]=i+1
                    }
                    var ws=XLSX.utils.json_to_sheet(results,{skipHeader:true});
                    //XLSX.utils.decode_range("B1:C9"); 
                    //ws['!ref'] = "A2:Z100";
                    /***export interface Sheet2JSONOpts extends DateNFOption {
                        /** Output format 
                        header?: "A"|number|string[];

                        /** Override worksheet range 
                        range?: any;

                        /** Include or omit blank lines in the output
                        blankrows?: boolean;

                        /** Default value for null/undefined values
                        defval?: any;

                        /** if true, return raw data; if false, return formatted text
                        raw?: boolean;

                        //if true, return raw numbers; if false, return formatted numbers
                        rawNumbers?: boolean;
                    }**/
                    h=XLSX.utils.sheet_to_html(ws,sheet2JSONOpts);
                    //console.log(h);
                    tab.innerHTML=h;
                    var t=document.getElementById('check');
                    //console.log(tab.rows.length);
                    for(var j = 0; j < tab.rows.length; j++){
                        var oCheckbox=document.createElement("input");
                        oCheckbox.setAttribute("type","checkbox");
                        var trr=document.createElement("tr");
                        var tdd=document.createElement("td");
                        tdd.appendChild(oCheckbox);
                        trr.appendChild(tdd);
                        t.appendChild(trr);
                    }
                }
            }
        };

        //点击th排序
        function makeSortable(table) {
            var headers=table.getElementsByTagName("th");
            for(var i=0;i<headers.length;i++){
                (function(n){
                    var flag=false;
                    headers[n].onclick=function(){
                        // sortrows(table,n);
                        var tbody=table.tBodies[0];//第一个<tbody>
                        var rows=tbody.getElementsByTagName("tr");//tbody中的所有行
                        rows=Array.prototype.slice.call(rows,0);//真实数组中的快照
        
                        //基于第n个<td>元素的值对行排序
                        rows.sort(function(row1,row2){
                            var cell1=row1.getElementsByTagName("td")[n];//获得第n个单元格
                            var cell2=row2.getElementsByTagName("td")[n];
                            var val1=cell1.textContent||cell1.innerText;//获得文本内容
                            var val2=cell2.textContent||cell2.innerText;
        
                            if(val1<val2){
                                return -1;
                            }else if(val1>val2){
                                return 1;
                            }else{
                                return 0;
                            }
                        });
                        if(flag){
                            rows.reverse();
                        }
                        //在tbody中按它们的顺序把行添加到最后
                        //这将自动把它们从当前位置移走，故没必要预先删除它们
                        //如果<tbody>还包含了除了<tr>的任何其他元素，这些节点将会悬浮到顶部位置
                        for(var i=0;i<rows.length;i++){
                            tbody.appendChild(rows[i]);
                        }
        
                        flag=!flag;
                    }
                }(i));
            }
        }
        
        window.onload=function(){
            var table=document.getElementsByTagName("table")[1];
            makeSortable(table);
        }

      </script>
  </body>
  </html>